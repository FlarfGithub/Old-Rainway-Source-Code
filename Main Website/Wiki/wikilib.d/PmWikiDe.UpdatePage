version=pmwiki-2.2.109 ordered=1 urlencoded=1
author=MFWolff
charset=UTF-8
csum=rm line no longer true; more about READPAGE_CURRENT
ctime=1305118943
name=PmWikiDe.UpdatePage
rev=10
targets=PmWikiDe.PageFileFormat,PmWikiDe.CustomMarkup,Cookbook.MarkupExpressionSamples,PmWikiDe.CustomActions,PmWiki.EditVariables,Cookbook.AutoCreatePages,PmWikiDe.SimultaneousEdits,PmWikiDe.Functions,Category.PmWikiInternals,Category.PmWikiDeveloper
text=(:title UpdatePage:)%0a(:Summary: technische Hinweise zur Funktion UpdatePage():)%0a(:Original_Page: PmWiki.{$Name} :)%0a(:Translation_Date: 2011-05-11:)%0a(:Translation_Status: %25green%25fertig%25%25:)%0a(:Audience: Entwickler:)%0a%0aDiese Seite ist ein Sammlung technischer Anmerkungen und Hinweise bezüglich der Funktion UpdatePage(). Man kann die ganzen Informationen auch bekommen, indem man den Kode in pmwiki.php liest, aber diese Seite fasst die Dinge in einer etwas besser lesbaren Form zusammen.%0a%0aSie ist aktuell bis 2.2.0.beta65.%0a%0a!! @@UpdatePage($editPageName, $old (page object), $new (page object));@@%0a%0aUpdatePage() erlaubt Kochbuchrezepten das Verhalten des Bearbeitens einer Seite in einem Browser nachzuahmen. Es nimmt ein Seitenobjekt (array) mit Seitendaten entgegen, dann führt es alle die üblichen PmWiki-Haushalts-Tätigkeiten durch, die abgearbeitet werden, wenn ein Text über ein Bearbeiten-Fenster  im Browser abgeschickt wird, als da sind history/diff-Informationen retten, Seitenrevisionsnummer hochzählen, RecentChanges-Seite updaten, Email-Benachrichtigung senden etc.:%0a* "PageObjekt" bezieht sich auf ein Array, das mit [@RetrieveAuthPage($NameDerBearbeitetenSeite, $level, $authprompt=true, $since=0);@] (bevorzugt) oder mit [@ReadPage($Pagename)@] (missachtet Sicherheit der Seite) geholt worden ist. Beachten Sie, dass $new['text'] alle Seiten-Daten für die neue Version des Textes enthalten sollte. Siehe [[PmWikiDe/PageFileFormat|+]] für weitere Informationen über den Typ der Informationen, die Sie über dieses Array erreichen.%0a* Wenn eine Seite nicht existiert, wird [@UpdatePage()@] versuchen, sie anzulegen.%0a* Wenn Sie $old abgefragt haben, indem Sie RetrieveAuthPage($editPageName,$auth,$prompt,READPAGE_CURRENT) benutzten und $new=$old setzten, wird UpdatePage oder WritePage auch alle Versionsdaten löschen (weil READPAGE_CURRENT nur die aktuelle Version der Seite liest und zurückgibt ohne jegliche Versionen; das Gleiche passiert mit [@ReadPage($pagename, READPAGE_CURRENT)@]). %0a%0a!!!Vorsicht%0aInkorrekt benutzt kann [@UpdatePage()@] nicht nur Seiteninhalte löschen, sondern kann auch den kompletten Verlauf (alle Versionen) einer Seite vernichten &ndash; PmWiki kann eine ältere Version nicht wiederherstellen, wenn Sie versehentlich den Verlauf beim Lesen oder Speichern einer Seite fallen lassen.%0a%0a!! Aufruf von [@UpdatePage()@]%0a%0a@@UpdatePage()@@ kann nicht von ''config.php'' oder einem eingefügten ([@include()@]d) Rezept direkt aufgerufen werden, weil es notwendige Initialisierungen gibt, die erst später in ''config.php'' erscheinen. Wenn Sie @@UpdatePage()@@ benutzen, dann innerhalb von [[PmWikiDe/CustomMarkup | eigenen Auszeichnungen]], eines [[Cookbook:MarkupExpressionSamples | eigenen Markup-Ausdrucks]] oder einer [[PmWikiDe/CustomActions | eigenen Aktion]].%0a%0a[@UpdatePage()@] macht selbst nicht viel außer [@$EditFunctions@] zu traversieren und jede darin enthaltene Funktion aufzurufen. ([@$EditFunctions@] kann überschrieben werden durch ein viertes Argument [@$fnlist@], aber das ist ziemlich selten).  %0a%0aDie globale Variable [@$IsPagePosted@] wird zum Start von [@UpdatePage()@] auf FALSE gesetzt und dann am Ende dieser Funktion zurückgegeben. %0aJede der eingreifenden Funktionen kann sie auf TRUE setzten (um anzuzeigen, dass das Veröffentlichen/Speichern erfolgreich war), aber normalerweise ist das der Job der Funktion PostPage().%0a%0aHier ist die Definition von  $EditFunctions aus pmwiki.php:%0a%0a[@$EditFunctions = array('EditTemplate', 'RestorePage', 'ReplaceOnSave',%0a  'SaveAttributes', 'PostPage', 'PostRecentChanges', 'AutoCreateTargets',%0a  'PreviewPage');@]%0a%0a!!!Rezepte können ändern, wie Bearbeiten wirkt%0a%0aKochbuchautoren können ihre eigenen Funktionen zu [@$EditFunctions@] hinzufügen, wenn sie welche benötigen.%0a%0aNehmen Sie zum Beispiel einmal an, Sie müssen den Seitennamen ([@$pagename@]) der gerade bearbeiteten Seite wissen (Mag sein, Sie haben [@$ROSPatterns@] erweitert):%0a%0a%0a[@%0a  global $EditFunctions; # if inside a function%0a  array_unshift($EditFunctions, "GetEditPagename");%0a  // ...%0a  function GetEditPagename($pagename, $p, $n) {%0a    global $EditPagename;%0a    $EditPagename=$pagename;%0a  }%0a@]%0a%0aOder Sie müssen noch etwas tun, nachdem eine Seite gespeichert wurde:%0a%0a[@%0a  $EditFunctions[]= "MyPostEditProcessing"; // Add to end of $EditFunctions%0a  function MyPostEditProcessing($pagename, $p, $n) {%0a    // mirror page to another site, send an email, update page lists somewhere, etc%0a    // Might check global $IsPagePosted%0a  }%0a@]%0a%0a!!Standardfunktionen von [@$EditFunctions@]%0a%0a!!! EditTemplate%0a %0aDiese Funktion erlaubt neue Seiten mit dem Inhalt einer Vorlagenseite vorzubelegen. Wenn der [@$new['text']@] irgendetwas enthält, tut diese Funktion nichts. %0a%0aDer Seitenname der Vorlage kann in [@$_REQUEST['template']@] übergeben werden.%0a%0aAndernfalls wird das [@$EditTemplatesFmt@]-Array traversiert und jede Seite gelesen bis ein Text aufgetrieben wird, der dann der Text für $new['text'] wird.%0a%0a%0a!!! RestorePage%0a%0aBeim normalen Speichern einer Seite macht diese Funktion nichts.%0a%0aDer Wert für $Restore kann als Argument an die Funktion übergeben werden, aber das passiert nicht im Kontext von UpdatePage(). Der Wert wird vielmehr von [@$_REQUEST['restore']@] geholt. Wenn dieser Wert nicht gesetzt ist, dann macht die Funktion nichts. Wenn der Wert auf einen Zeitstempel gesetzt ist, wird die PageHistory traversiert und die Seitenänderungen werden in umgekehrter Reihenfolge rückgängig gemacht, bis der übergebenen Zeitstempel erreicht ist. %0a%0a%0a!!! ReplaceOnSave%0a%0aEs gibt zwei Arrays:  [@$ROEPatterns@] und [@$ROSPatterns@]. In jedem Array ist der Schlüssel dieser assoziativen Arrays das Suchmuster und der assoziierte Wert ist der Ersatz dafür. [@$ROEPatterns@] wird bei jeder Bearbeitung ersetzt, [@$ROSPatterns@] nur wenn [@$EnablePost@] gesetzt ist.%0a%0a%0a!! SaveAttributes%0a%0aMehrere unterschiedliche Attribute werden berechnet als neue Schlüssel für das $new[]-Seiten-Array. (Jedes davon wird dann zu einer eigenen Zeile in der Seitendatei (siehe [[PageFileFormat|+]]). "Targets" wird zusammengestellt als leerzeichenseparierte Liste von Seiten, auf die von dieser Seite verwiesen wird. Eigenschaften, die in der globalen Variablen [@$SaveProperties@] gehalten werden, werden aus dem $page[](old page)-Array kopiert.  %0a%0a* '''Anmerkung:''' [@SaveAttributes@] ruft [@MarkupToHTML()@] für den Seitentext auf. Das setzt Seitenvariablen, kann aber Seiteneffekte haben (wenn Sie einen Zähler für Ihr Markup pflegen, die jedesmal in Dateien schreibt, wenn eine Seite angesehen wurde, etc.).%0a %0a!!! PostPage%0a%0a[@$IsPagePosted@] wird auf FALSE gesetzt.%0a%0aWenn [@$EnablePost@] wahr ist, dann ereignen sich folgende Schritte:%0a* Attribute wie 'charset' ([@$Charset@]), 'author' ([@$Author@]), 'author:%3ctimestamp>' ([@$Author@]), und 'host:%3ctimestamp>' ([@$_SERVER['REMOTE_ADDR']@]) werden gesetzt.%0a* Ein 'diff' wird bestimmt zwischen dem vorherigen und dem neuen Text und das Ergebnis wird gespeichert als ein '%3ctimestamp>'-Schlüssel.%0a* Wenn der Text auf die globale Variable [@$DeleteKeyPattern@] passt, wird die Seite gelöscht.%0a* WritePage() wird aufgerufen.%0a* [@$IsPagePosted@] wird auf TRUE gesetzt.%0a%0a%0a!!! PostRecentChanges%0a%0aWenn [@$IsPagePosted@] NICHT TRUE ist, dann tue nichts.%0a%0aDas globale Array [@$RecentChangesFmt[]@] wird traversiert, wobei der Schlüssel zum assoziativen Array der Name der Seite ist, in die die Änderung eingetragen werden soll, und der assoziierte Wert der Text ist, der in die Seite am Ende einzutragen ist.  %0a%0aWenn die Zeilenzahl in der RecentChanges-Seite den Wert der globalen Variable [@$RCLinesMax@] übersteigt, wird die Seite angemessen gekürzt. %0a%0aDie RecentChanges-Seite wird per WritePage() geschrieben.%0a%0a%0a!!! AutoCreateTargets%0a%0aWenn Verweisziele in der Seite auf bestimmte Globale passen und die Ziele existieren noch nicht, werden sie automatisch angelegt. Siehe auch [[(Cookbook:)AutoCreatePages]].%0a%0a%0a!!! PreviewPage%0a%0aDiese Funktion tut nichts, wenn Sie keine Vorschau machen.%0a%0a!!Weitere Funktionen von [@$EditFunctions@]%0a%0aEs gibt noch weitere Funktionen von [@$EditFunctions@] in PmWiki, sie sind aber nicht Teil der Basisfunktionalität:%0a%0a!!! author.php  %0a[@ array_unshift($EditFunctions,'RequireAuthor'); @]// Stellen Sie sicher, dass der Autor gesetzt ist, bevor die Seite bearbeitet werden darf.%0a%0a!!! blocklist.php%0a%0a[@ array_unshift($EditFunctions, 'CheckBlocklist'); @]%0a%0a!!! draft.php%0a%0a[@ array_unshift($EditFunctions, 'EditDraft'); @] // Prüfe, ob im Entwurf gespeichert wird und wenn, ändere Namen und leite um zur Entwurfseite für die weitere Bearbeitung.%0a%0a* '''Anmerkung''': Dies kann den Seitennamen ([@$pagename@]) unerwartet ändern.%0a%0a!!! notify.php%0a%0a[@ $EditFunctions[] = 'PostNotify'; @] // Füge 'PostNotify' hinzu um eine E-Mail zu versenden, wenn die Bearbeitung erfolgreich abgeschlossen ist.%0a%0a!!! pagelist.php%0a%0a[@ $EditFunctions[] = 'PostPageIndex'; @] // behandle [=(:pagelist:)=]-Funktionalität, nachdem eine Seite geändert wurde.%0a%0a!!! simuledit.php%0a%0a[@ array_unshift($EditFunctions,'MergeSimulEdits'); @] // Wenn mehr als eine Bearbeitung seit dem Laden der Seite erfolgte, pflege die Änderungen ein, bevor die Seite gespeichert wird.%0a* Siehe [[PmWikiDe/SimultaneousEdits|+]]%0a%0a!!! transition.php%0a%0aBehandelt Übergänge zwischen Versionen. Wird für 'GUI Edit buttons' genutzt.%0a%0a!!! urlapprove.php%0a%0a[@ array_splice($EditFunctions, array_search('PostPage', $EditFunctions), 0, 'BlockUnapprovedPosts'); @]%0a%0aSetzt die [@BlockUnapprovedPosts()@]-Funktion direkt vor [@PostPage()@]%0a%0a%0a[[#faq]]%0a>>faq%3c%3c%0a%0aQ: Kann ich  @@UpdatePage()@@ direkt in der ''config.php''-Datei aufrufen?%0a%0aA: Nein. Wie schon bei den [[PmWikiDe/Functions | Funktionen]] festgestellt: @@UpdatePage()@@ kann nicht direkt in ''config.php'' aufgerufen werden, weil es notwendige Initialisierungen gibt, die erst später passieren in ''pmwiki.php''. Es reicht nicht, nur ''stdconfig.php'' zu laden. Wenn Sie @@UpdatePage()@@ benutzen wollen, müssen Sie es innerhalb eines [[PmWikiDe/CustomMarkup | eigenen Markups]], eines [[Cookbook:MarkupExpressionSamples | 'custom markup expression']] oder einer [[PmWikiDe/CustomActions | eigenen Aktion]] tun.%0a%0a%0aKategorien: [[!PmWiki Internals]] [[!PmWiki Developer]]%0a
time=1539155680
title=UpdatePage
